from os import path
import glob

configfile: "config.yaml"

geno = config["assembly"]
paf = config["PAF_file"]
lg = config["lg_count"]
os = config["OS_info"]

rule all:
  input: "8_Repeatmask/repeatmasked.fa.gz"


rule repeatmask:
  input: "{geno}"
  output: "8_Repeatmask/repeatmasked.fa.gz"
  message: "Using Red to repeat-mask the genome assembly {input}"
  threads: 30
  shell:
    """
    file={input}
    if [ "${{file: -3}}" == ".gz" ]; then
      echo "Assembly is compressed, decompressing"
      file=$(basename $file .gz)
      gunzip --stdout {input} > $file
    fi
    ext=$(echo $file | rev | cut -d"." -f1 | rev)
    if [ $ext != "fa" ]; then
      echo "Assembly file extension must end in .fa for Red, creating a symlink with the corrected name"
      ln -sr $file ${{file}}.fa
    fi
    LA/deps/Red -gnm . -msk repeatmask -sco repeatmask -cnd repeatmask
    firstletters=$(echo $file | cut -c1-5 )
    mv repeatmask/${{firstletters}}*msk.fa.gz {output}
    """