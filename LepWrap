#! /usr/bin/env bash

if which snakemake &>/dev/null; then
  foo=1
else
  echo -e "ERROR:\nSnakemake installation is required to run LepWrap, but not found in the current environment."
  echo -e "If [ana|mini]conda are installed, created a pre-configred environment with:\n"
  printf "\033[01;32m"
  printf "conda env create -f conda_setup.yml\n"
  printf "\033[0m"
  exit 1
fi

if [ ! -f config.yaml ]; then
  echo -e "ERROR:\nThe file 'config.yaml' is required to run LepWrap, but not found in the current directory."
  exit 1
fi

if [[ -z "$1" ]]; then
  echo "Perform the modules of Lep-Map3 and optionally Lep-Anchor" 
  echo "Make sure config.yaml is properly configured for how you intend to run things."
  echo ""
  echo "[usage] LepWrap <number of threads to use>"
  echo "[example] LepWrap 16" 
  exit 1
fi

lepmap(){
  echo "Running Lep-Map3"
  sleep 2s
  snakemake --cores $1 --snakefile ./rules/LepMap3/LepMap3.smk --directory .
}

lepanchor(){
  LA=$(grep "run_lepanchor" config.yaml | cut -d":" -f2 | xargs | tr '[:upper:]' '[:lower:]')
  if [ $LA == "true" ]; then
    echo -e "\nRunning Lep-Anchor"
    sleep 2s
    snakemake --cores $1 --snakefile ./rules/LepAnchor/LepAnchor.smk --directory .
  else
    exit 1
  fi
}

lepmap && lepanchor